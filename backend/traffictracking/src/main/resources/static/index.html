<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TrafficTracking</title>
    <link rel="stylesheet" href="css/css-index.css" />
</head>

<body>
    <header>
        <!-- logo -->
        <h1>TrafficTracking</h1>
        <select class="language-selector">
            <option value="es">Español</option>
            <option value="en">English</option>
            <option value="val">Valencià</option>
        </select>
    </header>
    <div class="parent">
        <section class="grid-item div3">
            <div>
                <a target="_blank" class="enlaceRef"
                    href="https://developers.google.com/maps/documentation/javascript/examples/layer-traffic">Google
                    Maps Traffic Layer (Google)</a>
                <ul title="Leyenda traffiLayer Google Maps"></ul>
                <li style="color: #A92727" data-key="muy_lento">Muy lento</li>
                <li style="color: #ED4D42" data-key="lento">Lento</li>
                <li style="color: #FFCF42" data-key="rapido">Rápido</li>
                <li style="color: #16E098" data-key="muy_rapido">Muy rápido</li>
                </ul>
            </div>

            <div>
                <a target="_blank" class="enlaceRef"
                    href="https://valencia.opendatasoft.com/explore/dataset/estat-transit-temps-real-estado-trafico-tiempo-real/api/?flg=es-es">
                    Traffic Data Valencia (OpenDataSoft)</a>

                <ul title="Leyenda traffiLayer Google Maps">
                    <li style="color: #A92727" data-key="muy_lento">Muy lento</li>
                    <li style="color: #ED4D42" data-key="lento">Lento</li>
                    <li style="color: #FFCF42" data-key="rapido">Rápido</li>
                    <li style="color: #16E098" data-key="muy_rapido">Muy rápido</li>
                </ul>
            </div>

            <div>
                <a target="_blank" class="enlaceRef"
                    href="https://valencia.opendatasoft.com/explore/dataset/parkings/api/">
                    Parking Data Valencia (OpenDataSoft)</a>
                <ul title="Leyenda traffiLayer Google Maps">
                    <li style="color: #A92727" data-key="muy_lento">Muy lento</li>
                    <li style="color: #ED4D42" data-key="lento">Lento</li>
                    <li style="color: #FFCF42" data-key="rapido">Rápido</li>
                    <li style="color: #16E098" data-key="muy_rapido">Muy rápido</li>
                </ul>
            </div>
        </section>

        <section class="grid-item div1">
            <div>
                <select name="ciudades">
                    <option value="madrid" data-lat="40.416775" data-lng="-3.703790" data-key="madrid_centro">
                        Madrid Centro</option>
                    <option value="barajas" data-lat="40.472244" data-lng="-3.560891"
                        data-key="aeropuerto_barajas">Aeropuerto Barajas</option>
                    <option value="chamartin" data-lat="40.466443" data-lng="-3.684564">Chamartín</option>
                    <option value="retiro" data-lat="40.414572" data-lng="-3.681706" data-key="parque_retiro">
                        Parque Retiro</option>
                </select>

                <button onclick="cambiarUbicacion()" data-key="cambiar_ubicacion">Cambiar ubicación</button>
            </div>
            <!-- Aqui hay que hacer que el usuario al poner el raton encima le salga un texto de 
                 "el lugar favorito seleccionado sera al que te lleve la pagina al cargar" 
                 y que cuando lo cambie se recargue automaticamente-->
            <div>
                <select onfocus="asdkfjalsk" name="Lugares favoritos" id="">
                    <option value="Lugar 1">Lugar 1</option>
                    <option value="Lugar 2">Lugar 2</option>
                    <option value="Lugar 3">Lugar 3</option>
                </select>

                <button onclick="" data-key="add_favs">Añade a favoritos</button>
            </div>
        </section>

        <section class="grid.item div2">
            <div id="map"></div>
        </section>
    </div>

    <script>
        let map;
        function cambiarUbicacion() {
            const select = document.getElementById('ciudades');
            const opcionSeleccionada = select.options[select.selectedIndex];
            const nuevaLat = parseFloat(opcionSeleccionada.dataset.lat);
            const nuevaLng = parseFloat(opcionSeleccionada.dataset.lng);


            map.panTo({ lat: nuevaLat, lng: nuevaLng });
            map.setZoom(14);
        }
        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 12,
                center: { lat: 39.4699, lng: -0.3763 } // Valencia
            });

            const trafficLayer = new google.maps.TrafficLayer();
            trafficLayer.setMap(map);
            cargarDatos(0);
            cargarDatos(1);
            cargarDatos(2);
            cargarDatos(3);
            cargarDatos(4);
            cargarDatos(5);
            cargarDatos(6);
            cargarDatos(7);
            cargarDatos(8);
            cargarDatos(9);

        }
        function cargarDatos(estado) {

            // 0: Fluido
            // 1: Denso
            // 2: Congestionado
            // 3: Cortado
            // 4: Sin datos
            // 5: Paso inferior fluido
            // 6: Paso inferior denso
            // 7: Paso inferior congestionado
            // 8: Paso inferior cortado
            // 9: Sin datos (paso inferior)
            // Definir los estados de tráfico y sus colores
            const COLORES = {
                FLUIDO: "#16E098",            // Verde
                DENSO: "#FFCF42",             // Amarillo
                CONGESTIONADO: "#ED4D42",     // Rojo claro
                CORTADO: "#A92727",           // Rojo oscuro
                SIN_DATOS: "#808080",         // Gris
                PASO_FLUIDO: "#14B884",       // Verde más oscuro
                PASO_DENSO: "#E6B800",        // Amarillo más fuerte
                PASO_CONGESTIONADO: "#D6453D", // Rojo intermedio
                PASO_CORTADO: "#7A1E1E",      // Rojo muy oscuro
                PASO_SIN_DATOS: "#6B6B6B"     // Gris más oscuro
            };
            const estadosTrafico = {
                0: { estadoT: "Fluido", color: "#16E098" },         // Verde
                1: { estadoT: "Denso", color: "#FFCF42" },          // Amarillo
                2: { estadoT: "Congestionado", color: "#ED4D42" },  // Rojo claro
                3: { estadoT: "Cortado", color: "#A92727" },        // Rojo oscuro
                4: { estadoT: "Sin datos", color: "#808080" },      // Gris
                5: { estadoT: "Paso inferior fluido", color: "#16E098" },
                6: { estadoT: "Paso inferior denso", color: "#FFCF42" },
                7: { estadoT: "Paso inferior congestionado", color: "#ED4D42" },
                8: { estadoT: "Paso inferior cortado", color: "#A92727" },
                9: { estadoT: "Sin datos (paso inferior)", color: "#808080" }
            };


            fetch(`http://localhost:8080/trafico/estado/${estado}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Error en la respuesta de la API: " + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Datos recibidos:", data);

                    // Se asume que "data" es un array de registros
                    data.forEach(record => {
                        if (
                            record.fields &&
                            record.fields.geo_point_2d &&
                            Array.isArray(record.fields.geo_point_2d) &&
                            record.fields.geo_point_2d.length === 2
                        ) {
                            const [lat, lon] = record.fields.geo_point_2d;
                            console.log("Añadiendo marcador en:", lat, lon);

                            // Crear el marcador
                            const marker = new google.maps.Marker({
                                position: { lat: lat, lng: lon },
                                map: map, // Asegúrate de que "map" está inicializado
                                title: record.fields.denominacion || "Sin nombre",
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 6,
                                    fillColor: estadosTrafico[estado].color,
                                    fillOpacity: 1,
                                    strokeWeight: 0
                                }
                            });

                            // Crear el contenido del InfoWindow con más datos
                            const infoContent = `
          <div>
            <h3>${record.fields.denominacion || "Sin nombre"}</h3>
            <p><strong>Estado:</strong> ${record.fields.estado}</p>
            <p><strong>ID Tramo:</strong> ${record.fields.idtramo || "N/D"}</p>
            <!-- Agrega más datos según necesites -->
          </div>
        `;

                            const infoWindow = new google.maps.InfoWindow({
                                content: infoContent
                            });

                            // Asocia el evento click para abrir el InfoWindow
                            marker.addListener('click', () => {
                                infoWindow.open(map, marker);
                            });
                        } else {
                            console.error("No se encontraron coordenadas válidas en:", record);
                        }
                    });
                })
                .catch(error => console.error("Error cargando datos:", error));
        }

        const translations = {
            es: {
                muy_lento: "Muy lento",
                lento: "Lento",
                rapido: "Rápido",
                muy_rapido: "Muy rápido",
                ciudades: "Ciudades: ",
                madrid_centro: "Madrid Centro",
                aeropuerto_barajas: "Aeropuerto Baraja",
                parque_retiro: "Parque Retiro",
                cambiar_ubicacion: "Cambiar ubicación",
                add_favs: "Añadir a favoritos"
            },

            val: {
                muy_lento: "Molt llent",
                lento: "Llent",
                rapido: "Ràpid",
                muy_rapido: "Molt ràpid",
                ciudades: "Ciutats: ",
                madrid_centro: "Madrid Centre",
                aeropuerto_barajas: "Aeropuerto Baraja",
                parque_retiro: "Parc Retir",
                cambiar_ubicacion: "Cambiar ubicació",
                add_favs: "Incloure en favorits"
            },

            en: {
                muy_lento: "Very slow",
                lento: "Slow",
                rapido: "Fast",
                muy_rapido: "Very fast",
                ciudades: "Cities: ",
                madrid_centro: "Center Madrid",
                aeropuerto_barajas: "Baraja's Airport",
                parque_retiro: "Retiro's Park",
                cambiar_ubicacion: "Change ubication",
                add_favs: "Add to favourites"
            }
        };

        document.addEventListener("DOMContentLoaded", () => {
            const languageSwitcher = document.getElementById("language-selector");
            let lang = localStorage.getItem("lang") || "es";
            languageSwitcher.value = lang;
            applyTranslations(lang);

            languageSwitcher.addEventListener("change", (event) => {
                lang = event.target.value;
                localStorage.setItem("lang", lang);
                applyTranslations(lang);
            });
        });

        function applyTranslations(lang) {
            document.querySelectorAll("[data-key]").forEach(el => {
                el.innerText = translations[lang][el.getAttribute("data-key")];
            });
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyATHGvXCJNdfo1uEgJ4NZNt5Mi5Z8bfqXo&callback=initMap" async defer></script>
</body>


</html>